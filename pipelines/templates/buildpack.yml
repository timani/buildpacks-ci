---
resources:
  - name: buildpacks-pivnet-uploader
    type: git
    source:
      uri: git@github.com:pivotal-cf/buildpacks-pivnet-uploader
      private_key: {{buildpacks-pivnet-uploader-private-key}}
  - name: buildpacks-ci
    type: git
    source:
      uri: https://github.com/cloudfoundry/buildpacks-ci
  - name: cf-edge-environments
    type: pool
    source:
      branch: resource-pools
      pool: cf-edge-azure-environments
      private_key: {{resource-pools-private-key}}
      uri: git@github.com:cloudfoundry/buildpacks-ci.git
  - name: cf-lts-environments
    type: pool
    source:
      branch: resource-pools
      pool: cf-lts-azure-environments
      private_key: {{resource-pools-private-key}}
      uri: git@github.com:cloudfoundry/buildpacks-ci.git
  - name: compile-extensions
    type: git
    source:
      uri: https://github.com/cloudfoundry/compile-extensions.git
  - name: buildpack-packager
    type: github-release
    source:
      user: cloudfoundry
      repository: buildpack-packager
      access_token: {{buildpacks-github-token}}
  - name: machete
    type: github-release
    source:
      user: cloudfoundry
      repository: machete
      access_token: {{buildpacks-github-token}}
  - name: buildpack
    type: git
    source:
      uri: git@github.com:cloudfoundry/<%= language %>-buildpack.git
      private_key: {{<%= language %>-buildpack-private-key}}
      branch: develop
      ignore_paths:
        - VERSION
        - CHANGELOG
  - name: buildpack-master
    type: git
    source:
      uri: git@github.com:cloudfoundry/<%= language %>-buildpack.git
      private_key: {{<%= language %>-buildpack-private-key}}
      branch: master
  - name: pivotal-buildpack
    type: s3
    source:
      bucket: pivotal-buildpacks
      regexp: <%= language %>_buildpack-v(.*).zip
      access_key_id: {{pivotal-buildpacks-s3-access-key}}
      secret_access_key: {{pivotal-buildpacks-s3-secret-key}}
  - name: pivotal-buildpack-cached
    type: s3
    source:
      bucket: pivotal-buildpacks
      regexp: <%= language %>_buildpack-cached-v(.*).zip
      access_key_id: {{pivotal-buildpacks-s3-access-key}}
      secret_access_key: {{pivotal-buildpacks-s3-secret-key}}
  - name: buildpack-github-release
    type: github-release
    source:
      user: cloudfoundry
      repository: <%= language %>-buildpack
      access_token: {{buildpacks-github-token}}
  - name: buildpack-checksums
    type: git
    source:
      uri: git@bitbucket.org:cloudfoundry-buildpacks/buildpack-checksums.git
      private_key: {{buildpack-checksums-private-key}}
      branch: master
  - name: brats
    type: git
    source:
      uri: https://github.com/cloudfoundry/brats.git
  - name: failure-alert
    type: slack-notification
    source:
      url: {{concourse-job-failure-notifications-slack-webhook}}
jobs:
  - name: specs-edge-master
    serial: true
    plan:
      - put: cf-environments
        resource: cf-edge-environments
        params:
          acquire: true
      - aggregate:
        - get: buildpacks-ci
        - get: buildpack
          resource: buildpack-master
          trigger: true
        - get: pivotal-buildpacks
          resource: pivotal-buildpack
          trigger: true
        - get: pivotal-buildpacks-cached
          resource: pivotal-buildpack-cached
          trigger: true
      - do:
        - task: rspec
          file: buildpacks-ci/tasks/test-buildpack.yml
          params:
            STACKS: cflinuxfs2
            COMPOSER_GITHUB_OAUTH_TOKEN: {{composer-github-oauth-token}}
            CF_PASSWORD: {{ci-cf-password}}
            CF_EDGE: 'true'
          privileged: true
          ensure:
            put: cf-edge-environments
            params:
              release: cf-environments
        on_failure:
          put: failure-alert
          params:
            text: "<%= language %>-buildpack specs-edge-master job on Concourse failed! \n Check: https://buildpacks.ci.cf-app.com/pipelines/<%= language %>-buildpack/jobs/specs-edge-master"
            channel: {{concourse-job-failure-notifications-slack-channel}}
            username: concourse
            icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
  - name: specs-lts-master
    serial: true
    plan:
      - put: cf-environments
        resource: cf-lts-environments
        params:
          acquire: true
      - aggregate:
        - get: buildpacks-ci
        - get: buildpack
          resource: buildpack-master
          trigger: true
        - get: pivotal-buildpacks
          resource: pivotal-buildpack
          trigger: true
        - get: pivotal-buildpacks-cached
          resource: pivotal-buildpack-cached
          trigger: true
      - do:
        - task: rspec
          file: buildpacks-ci/tasks/test-buildpack.yml
          params:
            STACKS: cflinuxfs2
            COMPOSER_GITHUB_OAUTH_TOKEN: {{composer-github-oauth-token}}
            CF_PASSWORD: {{ci-cf-password}}
          privileged: true
          ensure:
            put: cf-lts-environments
            params:
              release: cf-environments
        on_failure:
          put: failure-alert
          params:
            text: "<%= language %>-buildpack specs-lts-master job on Concourse failed! \n Check: https://buildpacks.ci.cf-app.com/pipelines/<%= language %>-buildpack/jobs/specs-lts-master"
            channel: {{concourse-job-failure-notifications-slack-channel}}
            username: concourse
            icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
  - name: specs-edge-develop
    serial: true
    plan:
      - put: cf-environments
        resource: cf-edge-environments
        params:
          acquire: true
      - aggregate:
        - get: buildpacks-ci
        - get: brats
        - get: buildpack
          trigger: true
      - do:
        - task: rspec
          file: buildpacks-ci/tasks/test-buildpack.yml
          params:
            STACKS: cflinuxfs2
            COMPOSER_GITHUB_OAUTH_TOKEN: {{composer-github-oauth-token}}
            CF_PASSWORD: {{ci-cf-password}}
            CF_EDGE: 'true'
          privileged: true
<% unless language == "binary" %>
        - task: brats
          file: buildpacks-ci/tasks/run-brats.yml
          params:
            BRATS_BRANCH: develop
            CI_CF_USERNAME: {{ci-cf-username}}
            CI_CF_PASSWORD: {{ci-cf-password}}
            LANGUAGE: <%= language %>
<% end %>
        on_failure:
          put: failure-alert
          params:
            text: "<%= language %>-buildpack specs-edge-develop job on Concourse failed! \n Check: https://buildpacks.ci.cf-app.com/pipelines/<%= language %>-buildpack/jobs/specs-edge-develop"
            channel: {{concourse-job-failure-notifications-slack-channel}}
            username: concourse
            icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
        ensure:
          put: cf-edge-environments
          params:
            release: cf-environments
  - name: specs-lts-develop
    serial: true
    plan:
      - put: cf-environments
        resource: cf-lts-environments
        params:
          acquire: true
      - aggregate:
        - get: buildpacks-ci
        - get: brats
        - get: buildpack
          trigger: true
      - do:
        - task: rspec
          file: buildpacks-ci/tasks/test-buildpack.yml
          params:
            STACKS: cflinuxfs2
            COMPOSER_GITHUB_OAUTH_TOKEN: {{composer-github-oauth-token}}
            CF_PASSWORD: {{ci-cf-password}}
          privileged: true
        - task: brats
          file: buildpacks-ci/tasks/run-brats.yml
          params:
            BRATS_BRANCH: develop
            CI_CF_USERNAME: {{ci-cf-username}}
            CI_CF_PASSWORD: {{ci-cf-password}}
            LANGUAGE: <%= language %>
        on_failure:
          put: failure-alert
          params:
            text: "<%= language %>-buildpack specs-lts-develop job on Concourse failed! \n Check: https://buildpacks.ci.cf-app.com/pipelines/<%= language %>-buildpack/jobs/specs-lts-develop"
            channel: {{concourse-job-failure-notifications-slack-channel}}
            username: concourse
            icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
        ensure:
          put: cf-lts-environments
          params:
            release: cf-environments
